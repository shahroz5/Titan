<div class="pw-confirmation-box">
  <div
    class="row pw-confirmation-box__header"
    cdkDragBoundary=".cdk-overlay-container"
    cdkDragRootElement=".cdk-overlay-pane"
    cdkDrag
    cdkDragHandle
  >
    <div class="col-auto">{{ 'pw.cnPayment.cnHeaderLabel' | translate }}</div>
    <div class="col pw-text-right">
      <button
        class="pw-confirmation-box__icon-button"
        mat-icon-button
        (click)="close()"
      >
        <mat-icon>
          <span class="pw-i-24 pw-close-no-border-icon-24"></span>
        </mat-icon>
      </button>
    </div>
  </div>
  <div
    class="pw-confirmation-box__body pw-confirmation-box__padding-bottom-0 pw-padding-bottom-0"
  >
    <mat-tab-group
      dynamicHeight
      mat-stretch-tabs
      class="pw-mat-tab pw-confirmation-box__margin-top-0 pw-margin-bottom-0"
      (selectedTabChange)="onTabChange($event)"
      [(selectedIndex)]="activeTab"
    >
      <ng-container>
        <mat-tab
          class="pw-mat-tab__item"
          label="{{ 'pw.cnPayment.redeemTabHeading' | translate }}"
        >
          <form [formGroup]="creditNoteListForm">
            <div
              class="pw-scrollable-table"
              *ngIf="
                creditNoteListValue && creditNoteListValue.cnList.length > 0
              "
            >
              <table
                class="pw-grid-table pw-grid-table__scrollable"
                aria-describedby="table"
              >
                <thead>
                  <tr class="pw-grid-table__background-header">
                    <th class="pw-grid-table__header-item" scope="col">
                      {{ 'pw.cnPayment.priorityLabel' | translate }}
                    </th>
                    <th class="pw-grid-table__header-item" scope="col">
                      {{ 'pw.cnPayment.cnNumberLabel' | translate }}
                    </th>
                    <th class="pw-grid-table__header-item" scope="col">
                      {{ 'pw.cnPayment.cnTypeLabel' | translate }}
                    </th>
                    <th class="pw-grid-table__header-item" scope="col">
                      {{ 'pw.cnPayment.financialYearLabel' | translate }}
                    </th>
                    <th class="pw-grid-table__header-item" scope="col">
                      {{ 'pw.cnPayment.cashCollectedLabel' | translate }}
                      ({{ data.currencyCode | currencySymbol }})
                    </th>
                    <th class="pw-grid-table__header-item" scope="col">
                      {{ 'pw.cnPayment.availableAmtLabel' | translate }}
                      ({{ data.currencyCode | currencySymbol }})
                    </th>
                    <th class="pw-grid-table__header-item" scope="col">
                      Estimated Disc. ({{ data.currencyCode | currencySymbol }})
                    </th>
                    <th class="pw-grid-table__header-item" scope="col">
                      {{ 'pw.cnPayment.redeemingAmtLabel' | translate }}
                      ({{ data.currencyCode | currencySymbol }})
                    </th>
                    <th class="pw-grid-table__header-item" scope="col"></th>
                  </tr>
                </thead>
                <tbody
                  class="pw-grid-table__body"
                  formArrayName="creditNoteDetails"
                >
                  <tr
                    class="pw-grid-table__row"
                    *ngFor="
                      let creditNote of creditNoteListValue.cnList;
                      let i = index
                    "
                    [formGroupName]="i"
                  >
                    <td class="pw-grid-table__item">
                      <div class="pw-grid-table__number">
                        {{ creditNote.priority }}
                      </div>
                    </td>
                    <td class="pw-grid-table__item">{{ creditNote.docNo }}</td>
                    <td class="pw-grid-table__item">
                      {{ creditNote.creditNoteType }}
                    </td>
                    <td class="pw-grid-table__item">
                      {{ creditNote.fiscalYear }}
                    </td>
                    <td class="pw-grid-table__item">
                      {{ creditNote.cashCollected }}
                    </td>
                    <td class="pw-grid-table__item">
                      {{ creditNote.amount }}
                    </td>
                    <td class="pw-grid-table__item">
                      {{ getCNRivaahGHSDiscDetails(creditNote) }}
                    </td>
                    <td class="pw-grid-table__item pw-grid-table__credit-item">
                      <mat-form-field
                        appearance="outline"
                        class="pw-full-bordered-input-box pw-form-field-padding-bottom-0 pw-form-field-border-top-0"
                        [ngClass]="
                          creditNote.totalDiscount === 0 ||
                          creditNote.amount + creditNote.totalDiscount <
                            totalAmountDue ||
                          itemsArray.controls[i].get('redeemingAmount')
                            .value === creditNote.amount
                            ? 'pw-readonly-field'
                            : ''
                        "
                      >
                        <input
                          matInput
                          formControlName="redeemingAmount"
                          autocomplete="off"
                          possWebAmountInput
                          [allowDecimal]="false"
                          [readonly]="
                            creditNote.totalDiscount === 0 ||
                            creditNote.amount + creditNote.totalDiscount <
                              totalAmountDue ||
                            itemsArray.controls[i].get('redeemingAmount')
                              .value === creditNote.amount
                          "
                        />
                      </mat-form-field>
                      <mat-error
                        class="pw-error-color pw-d-inline"
                        *ngIf="
                          itemsArray.controls[i].get('redeemingAmount')
                            .errors &&
                          itemsArray.controls[i].get('redeemingAmount').errors
                            .errorArray
                        "
                      >
                        <poss-web-error-info-tooltip
                          [errorMessage]="
                            itemsArray.controls[i].get('redeemingAmount').errors
                              .errorArray
                          "
                        ></poss-web-error-info-tooltip>
                      </mat-error>
                    </td>
                    <td class="pw-grid-table__item">
                      <button
                        type="button"
                        class="pw-btn pw-showmore-btn-green"
                        (click)="
                          addRegularCN(i, creditNote.docNo, creditNote.priority)
                        "
                        *ngIf="
                          itemsArray.controls[i].get('isSelected').value ===
                          false
                        "
                      >
                        Add
                      </button>
                      <button
                        *ngIf="
                          itemsArray.controls[i].get('isSelected').value ===
                            true &&
                          creditNote.linkedTxnId === null &&
                          creditNote.totalDiscount === 0
                        "
                        class="pw-btn pw-showmore-btn-red"
                        (click)="removePaymentDetails(i, creditNote.docNo)"
                      >
                        Remove
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <h4
              class="pw-scrollable-table pw-text-center pw-line-height"
              *ngIf="
                creditNoteListValue && creditNoteListValue.cnList.length === 0
              "
            >
              {{ 'pw.cnPayment.noResultLabel' | translate }}
            </h4>
            <div class="row pb-2">
              <div class="col-5">
                <span class="pw-confirmation-box__label">
                  {{ 'pw.cnPayment.remainingAmtLabel' | translate }}</span
                >
                <span
                  class="pw-font-weight-bold"
                  *ngIf="data.totalAmountDue$ | async; else other_content"
                  >: {{ totalAmountDue | currencyFormatter }}</span
                >
                <ng-template #other_content>
                  <span class="pw-font-weight-bold"
                    >: {{ totalAmountDue | currencyFormatter }}</span
                  >
                </ng-template>

                <div class="pw-error-color">
                  {{ errorMeassge }}
                </div>
                <div class="pw-error-color">
                  {{ validationErrorMsg }}
                </div>
              </div>
              <div class="col-5 ml-auto">
                <div class="row">
                  <div class="col-8 pw-confirmation-box__label">
                    <span class="pw-font-weight-bold"
                      >{{
                        'pw.cnPayment.addedCNDetailsLabel' | translate
                      }}:</span
                    >
                  </div>
                  <div class="col-4"></div>
                </div>
                <div class="row">
                  <div class="col-6 pw-confirmation-box__label">
                    {{ 'pw.cnPayment.totalCNQtyLabel' | translate }}
                  </div>
                  <div class="col-4">
                    <span class="pw-font-weight-bold">: {{ totalQty }}</span>
                  </div>
                </div>
                <div class="row">
                  <div class="col-6 pw-confirmation-box__label">
                    {{ 'pw.cnPayment.totalCNValuationLabel' | translate }}
                  </div>
                  <div class="col-4">
                    <span class="pw-font-weight-bold"
                      >: {{ totalEvaluation | currencyFormatter }}</span
                    >
                  </div>
                </div>
              </div>
              <div class="col-auto align-items-flex-end mt-auto">
                <button class="pw-btn pw-accent-btn" (click)="close()">
                  {{ 'pw.cnPayment.submitButtonLabel' | translate }}
                </button>
              </div>
            </div>
          </form>
        </mat-tab>
      </ng-container>
      <ng-container>
        <mat-tab
          class="pw-mat-tab__item"
          label="{{ 'pw.cnPayment.thirdPartCnTabHeading' | translate }}"
        >
          <div class="pw-confirmation-box__body-item-without-padding">
            <div class="pw-scrollable-table pw-overflowx-hidden">
              <div
                [ngClass]="
                  invokedCN !== null && invokedCN !== undefined
                    ? 'pw-confirmation-box__fixed-height'
                    : 'pw-confirmation-box__another-height'
                "
              >
                <form [formGroup]="invokeCNForm" autocomplete="off">
                  <div class="row pw-confirmation-box__margin-bottom-10">
                    <mat-form-field
                      class="col-lg-auto col-4 pw-confirmation-box__item"
                    >
                      <mat-label>
                        {{ 'pw.cnPayment.enterCNLabel' | translate }}</mat-label
                      >
                      <input matInput formControlName="cnNumber" required />
                      <mat-error
                        *ngIf="
                          invokeCNForm.get('cnNumber').errors &&
                          invokeCNForm.get('cnNumber').errors.errorArray
                        "
                      >
                        <poss-web-error-info-tooltip
                          [errorMessage]="
                            invokeCNForm.get('cnNumber').errors.errorArray
                          "
                        ></poss-web-error-info-tooltip>
                      </mat-error>
                    </mat-form-field>
                    <poss-web-fiscal-year
                      class="col-lg-3 col-4 pw-confirmation-box__item"
                      [control]="invokeCNForm.get('fiscalYear')"
                      [required]="true"
                      [currentFiscalYear]="currentFiscalYear"
                      [placeHolder]="'pw.cnPayment.fiscalYearLabel' | translate"
                      [data]="invokeCNForm.get('fiscalYear').value"
                      [disabled]="false"
                    ></poss-web-fiscal-year>

                    <div class="col-lg-auto col-4 pw-confirmation-box__item">
                      <button class="pw-btn pw-accent-btn" (click)="invokeCN()">
                        {{ 'pw.cnPayment.invokeCNLabel' | translate }}
                      </button>
                    </div>
                  </div>

                  <div *ngIf="data.invokedCreditNote$ | async">
                    <ng-container
                      *ngIf="invokedCN !== null && invokedCN !== undefined"
                    >
                      <div class="row pw-confirmation-box__margin-bottom-10">
                        <div class="col-3 pw-tertiary-color">
                          {{ 'pw.cnPayment.dateLabel' | translate }}
                        </div>
                        <div
                          class="col-auto pw-grid-card__label pw-grid-card__padding-5"
                        >
                          :
                        </div>
                        <div
                          class="col pw-font-weight-bold"
                          *ngIf="invokedCN.docDate !== null"
                        >
                          {{ invokedCN.docDate | dateFormatter }}
                        </div>
                        <div
                          class="col pw-font-weight-bold"
                          *ngIf="invokedCN.docDate === null"
                        >
                          N/A
                        </div>
                      </div>
                      <div class="row pw-confirmation-box__margin-bottom-10">
                        <div class="col-3 pw-tertiary-color">
                          {{ 'pw.cnPayment.cnTypeLabel' | translate }}
                        </div>
                        <div
                          class="col-auto pw-grid-card__label pw-grid-card__padding-5"
                        >
                          :
                        </div>
                        <div class="col pw-font-weight-bold">
                          {{ invokedCN.creditNoteType }}
                        </div>
                      </div>
                      <div class="row pw-confirmation-box__margin-bottom-10">
                        <div class="col-3 pw-tertiary-color">
                          {{ 'pw.cnPayment.cnAmountLabel' | translate }}
                        </div>
                        <div
                          class="col-auto pw-grid-card__label pw-grid-card__padding-5"
                        >
                          :
                        </div>
                        <div class="col pw-font-weight-bold">
                          {{ invokedCN.amount | currencyFormatter }}
                        </div>
                      </div>
                      <div class="row pw-confirmation-box__margin-bottom-10">
                        <div class="col-3 pw-tertiary-color">
                          {{ 'pw.cnPayment.redeemingAmtLabel' | translate }}
                        </div>
                        <div
                          class="col-auto pw-grid-card__label pw-grid-card__padding-5"
                        >
                          :
                        </div>
                        <mat-form-field
                          class="pw-form-field-padding-bottom-0 pw-form-field-border-top-0"
                          *ngIf="
                            invokedCN.totalDiscount !== 0 &&
                            invokedCN.amount + invokedCN.totalDiscount >
                              totalAmountDue
                          "
                        >
                          <input
                            matInput
                            formControlName="redeemingAmount"
                            autocomplete="off"
                            possWebAmountInput
                            [allowDecimal]="false"
                          />
                          <mat-error
                            matSuffix
                            class="pw-error-color"
                            *ngIf="
                              invokeCNForm.get('redeemingAmount').errors &&
                              invokeCNForm.get('redeemingAmount').errors
                                .errorArray
                            "
                          >
                            <poss-web-error-info-tooltip
                              [errorMessage]="
                                invokeCNForm.get('redeemingAmount').errors
                                  .errorArray
                              "
                            ></poss-web-error-info-tooltip>
                          </mat-error>
                        </mat-form-field>

                        <div
                          *ngIf="
                            invokedCN.totalDiscount === 0 ||
                            invokedCN.amount + invokedCN.totalDiscount <
                              totalAmountDue
                          "
                        >
                          <div
                            class="col pw-font-weight-bold"
                            *ngIf="totalAmountDue >= invokedCN.amount"
                          >
                            {{ invokedCN.amount | currencyFormatter }}
                          </div>
                          <div
                            class="col pw-font-weight-bold"
                            *ngIf="totalAmountDue < invokedCN.amount"
                          >
                            {{ totalAmountDue | currencyFormatter }}
                          </div>
                        </div>
                      </div>
                      <div class="row pw-confirmation-box__margin-bottom-10">
                        <div class="col-3 pw-tertiary-color">
                          {{ 'pw.cnPayment.estimatedDiscLabel' | translate }}
                        </div>
                        <div
                          class="col-auto pw-grid-card__label pw-grid-card__padding-5"
                        >
                          :
                        </div>
                        <div class="col pw-font-weight-bold">
                          {{ invokedCN.totalDiscount | currencyFormatter }}
                        </div>
                      </div>
                      <div class="row pw-confirmation-box__margin-bottom-10">
                        <div class="col-3 pw-tertiary-color">
                          {{
                            'pw.cnPayment.chequeClearingDateLabel' | translate
                          }}
                        </div>
                        <div
                          class="col-auto pw-grid-card__label pw-grid-card__padding-5"
                        >
                          :
                        </div>
                        <div class="col pw-font-weight-bold">N/A</div>
                      </div>
                      <div class="row pw-confirmation-box__margin-bottom-10">
                        <div class="col-3 pw-tertiary-color">
                          {{ 'pw.cnPayment.mobileNumberLabel' | translate }}
                        </div>
                        <div
                          class="col-auto pw-grid-card__label pw-grid-card__padding-5"
                        >
                          :
                        </div>
                        <div class="col pw-font-weight-bold">
                          {{ invokedCN?.mobileNumber }}
                        </div>
                      </div>
                    </ng-container>
                  </div>
                  <div
                    class="pw-confirmation-box__margin-bottom-10 pw-error-color"
                  >
                    {{ invokeCNErrorMsg }}
                  </div>
                  <div
                    class="pw-confirmation-box__margin-bottom-10 pw-success-color"
                  >
                    {{ paymentAddSuccessMessage }}
                  </div>

                  <div
                    class="row pw-confirmation-box__margin-bottom-10 align-items-baseline"
                    *ngIf="
                      invokedCN !== null &&
                      invokedCN !== undefined &&
                      isOTPAllowed === true &&
                      isOTPAllowedForMinimunCN === true
                    "
                  >
                    <div class="col-auto" *ngIf="invokedCN?.mobileNumber">
                      <button
                        class="pw-btn pw-primary-btn"
                        (click)="generateOTP(invokedCN)"
                      >
                        <span
                          *ngIf="
                            isOtpGeneratedForCN === false ||
                            isOtpGeneratedForCN === null
                          "
                        >
                          Generate OTP</span
                        >
                        <span *ngIf="isOtpGeneratedForCN === true"
                          >Re-send OTP</span
                        >
                      </button>
                    </div>

                    <div
                      *ngIf="isOtpGeneratedForCN || !invokedCN?.mobileNumber"
                      class="col-auto"
                    >
                      <button
                        class="pw-btn pw-primary-btn mt-2"
                        (click)="withoutOTP()"
                      >
                        <span>{{
                          'pw.cnPayment.withoutOTPLabel' | translate
                        }}</span>
                      </button>
                    </div>

                    <div *ngIf="enablePhotoIDProofUpload" class="col-auto">
                      <poss-web-file-upload
                        [uploadLabel]="
                          'pw.cnPayment.photoIDUploadLabel' | translate
                        "
                        [imageUrl]="photoIDProofUrl"
                        [previewHeader]="
                          'pw.cnPayment.photoIDPreviewLabel' | translate
                        "
                        [fileName]="'pw.cnPayment.viewPhotoIDLabel' | translate"
                        [isViewLabelWithoutHeading]="true"
                        (fileEmitter)="uploadSuccess($event)"
                        (errorEmitter)="uploadError($event)"
                        (clearEmitter)="clear()"
                      ></poss-web-file-upload>
                    </div>

                    <mat-form-field
                      class="col-lg-3 col-4 pw-confirmation-box__item"
                      *ngIf="invokedCN?.mobileNumber"
                    >
                      <mat-label> OTP </mat-label>
                      <input
                        matInput
                        [required]="data.isOtpGeneratedForCn$ | async"
                        formControlName="otp"
                        (change)="
                          onInputValueChange(invokeCNForm.get('otp').value)
                        "
                      />
                      <mat-error
                        *ngIf="
                          invokeCNForm.get('otp').errors &&
                          invokeCNForm.get('otp').errors.errorArray
                        "
                      >
                        <poss-web-error-info-tooltip
                          [errorMessage]="
                            invokeCNForm.get('otp').errors.errorArray
                          "
                        ></poss-web-error-info-tooltip>
                      </mat-error>
                    </mat-form-field>
                  </div>
                  <p
                    class="pw-tertiary-color"
                    *ngIf="data.isOtpGeneratedForCn$ | async"
                  >
                    OTP has been sent to {{ invokedCN?.mobileNumber }}
                  </p>
                </form>
              </div>

              <div class="row pw-confirmation-box__body-item-without-padding">
                <div
                  *ngIf="isOtpGeneratedForCN || !invokedCN?.mobileNumber"
                  class="col-auto pw-check-box-proof"
                >
                  <mat-checkbox
                    class="pw-check-box-proof"
                    [formControl]="isPhotoIDProofCollected"
                    >{{
                      'pw.cnPayment.photoIDProofCollectedLabel' | translate
                    }}</mat-checkbox
                  >
                </div>
              </div>
              <div class="row">
                <div class="col-auto">
                  <p
                    class="pw-error-color"
                    *ngIf="
                      enablePhotoIDProofUpload && !idProofUploadedForWithoutOTP
                    "
                  >
                    {{
                      'pw.cnPayment.photoIDProofUploadWarningMsg' | translate
                    }}
                  </p>
                </div>
              </div>
            </div>

            <div
              class="pw-confirmation-box__footer-box row"
              *ngIf="invokedCN !== null && invokedCN !== undefined"
            >
              <div class="col-auto">
                <div class="pw-error-color">
                  {{ validationErrorMsg }}
                </div>
              </div>
              <div class="col-auto ml-auto">
                <button
                  mat-flat-button
                  class="pw-btn pw-accent-btn"
                  (click)="addThirdPartyCN(invokedCN)"
                  [disabled]="addCNButtonValidation()"
                >
                  {{ 'pw.cnPayment.addCNLabel' | translate }}
                </button>
              </div>
            </div>
          </div>
        </mat-tab>
      </ng-container>
    </mat-tab-group>
  </div>
</div>
