<div [class.pw-overlay-notification-gutter]="hasNotification">
  <div class="container-fluid">
    <div class="row">
      <div class="col-12 col-lg-1"></div>
      <div class="col-12 col-lg-10 m-auto">
        <div class="pw-top-heading-container">
          <div class="row pw-top-heading-container__item">
            <div class="col-auto">
              <div class="pw-top-heading-container__main-head">
                <a (click)="back()">
                  <span class="pw-i-24 pw-back-arrow-icon-24"></span>
                </a>
                <span class="pw-i-36 pw-instock-icon-36"></span>
                <div>
                  <h2>{{ 'pw.conversion.inStock' | translate }}</h2>
                  <h5 class="pw-top-heading-container__sub-heading">
                    {{ 'pw.conversion.management' | translate }}
                  </h5>
                </div>
              </div>
            </div>
          </div>
        </div>
        <h3 class="mb-3">{{ 'pw.conversion.title' | translate }}</h3>
        <div class="pw-tab">
          <ul #tabRef class="pw-tab__list">
            <li id="sent" class="pw-tab__list-item">
              <a
                [class.pw-is-active-bar]="
                  tab === InStockConversionTypesEnumRef.SEARCH
                "
                (click)="changeType(InStockConversionTypesEnumRef.SEARCH)"
              >
                <h5 class="pw-tab__item">
                  {{ 'pw.conversion.searchByVariantTabText' | translate }}
                </h5>
              </a>
            </li>
            <li id="requests" class="pw-tab__list-item">
              <a
                [class.pw-is-active-bar]="
                  tab === InStockConversionTypesEnumRef.REQUEST
                "
                (click)="changeType(InStockConversionTypesEnumRef.REQUEST)"
              >
                <h5 class="pw-tab__item">
                  {{ 'pw.conversion.requestSentTabText' | translate }}
                  <span class="pw-fourth-color"
                    >({{ conversionRequestsCount }})</span
                  >
                </h5>
              </a>
            </li>
            <li id="history" class="pw-tab__list-item">
              <a
                [class.pw-is-active-bar]="
                  tab === InStockConversionTypesEnumRef.HISTORY
                "
                (click)="changeType(InStockConversionTypesEnumRef.HISTORY)"
              >
                <h5 class="pw-tab__item">
                  {{ 'pw.conversion.history' | translate }}
                </h5>
              </a>
            </li>
          </ul>
        </div>
        <div
          class="row mb-3"
          [ngClass]="{ hidden: tab != InStockConversionTypesEnumRef.REQUEST }"
        >
          <mat-form-field
            class="col-lg-3 col-sm-4 ml-auto pw-search-bar pw-form-field-border-top-0"
            floatLabel="never"
          >
            <input
              #searchBox
              matInput
              class="pw-input-box"
              [placeholder]="'pw.conversion.searchPlaceholderText' | translate"
              [formControl]="searchFormControl"
              (keypress)="numberCheck($event)"
            />
            <mat-icon matSuffix>
              <span
                *ngIf="!searchFormControl.value"
                class="pw-i-16 pw-search-icon-16"
              ></span
            ></mat-icon>
            <mat-icon matSuffix (click)="clearSearch()">
              <span
                *ngIf="searchFormControl.value"
                class="pw-i-10 pw-close-icon-16"
              ></span
            ></mat-icon>
          </mat-form-field>
        </div>

        <div
          class="row mt-3"
          *ngIf="tab === InStockConversionTypesEnumRef.SEARCH"
        >
          <poss-web-item-search-list
            [placeholder]="
              'pw.conversion.searchListPlaceholderText' | translate
            "
            (search)="search($event)"
            [itemList]="searchedItemsList"
            [hasResults]="
              !((hasSearchedItems$ | async) && searchedItemsList.length == 0)
            "
            (selected)="onSearchItemsSelected($event)"
            class="col-12 m-auto"
          >
            <ng-template let-item="data">
              <poss-web-conversion-item
                [item]="item"
                [tab]="0"
                [hasForm]="0"
                [isSearching]="true"
                class="pw-list-card d-block"
                (loadImageEvent)="loadImageUrl($event, true)"
              >
              </poss-web-conversion-item>
            </ng-template>
          </poss-web-item-search-list>
        </div>
        <div
          class="row align-items-center mb-2"
          [ngClass]="{ hidden: tab === InStockConversionTypesEnumRef.SEARCH }"
        >
          <div
            class="col-auto row"
            [ngClass]="{
              hidden: tab !== InStockConversionTypesEnumRef.HISTORY
            }"
          >
            <div class="col-auto" [formGroup]="historyFormGroup">
              <mat-radio-group
                aria-label="Select an option"
                formControlName="selectRadioButton"
              >
                <mat-radio-button
                  value="{{ conversionEnumRef.REQUEST_SENT }}"
                  class="mr-3"
                  class="col-auto"
                >
                  <p class="pw-radio-btn__label">
                    {{ 'pw.conversion.requestSent' | translate }}
                  </p>
                </mat-radio-button>
                <mat-radio-button
                  class="mr-3"
                  class="col-auto"
                  value="{{ conversionEnumRef.CONVERTED_TRANSACTION }}"
                >
                  <p class="pw-radio-btn__label">
                    {{ 'pw.conversion.convertedTransaction' | translate }}
                  </p>
                </mat-radio-button>
              </mat-radio-group>
            </div>
          </div>
          <div
            class="col-auto ml-auto"
            [ngClass]="{
              hidden: tab !== InStockConversionTypesEnumRef.HISTORY
            }"
          >
            <a (click)="advancedFilter()">
              <p>
                <span
                  class="pw-i-24 pw-filter-icon-24 pw-filter-box__icon"
                  [ngClass]="
                    !(
                      (advanceFilter?.requestFromDate == null ||
                        advanceFilter?.requestFromDate == '') &&
                      (advanceFilter?.requestToDate == null ||
                        advanceFilter?.requestToDate == '') &&
                      (advanceFilter?.fiscalYear == null ||
                        advanceFilter?.fiscalYear == '')
                    )
                      ? 'pw-filter-icon-color-24'
                      : ''
                  "
                ></span>
                <span class="pw-font-weight-bold">
                  {{ 'pw.conversion.filter' | translate }}</span
                >
              </p>
            </a>
          </div>
          <div
            class="col-lg-3 col-4"
            [hidden]="tab !== InStockConversionTypesEnumRef.HISTORY"
          >
            <mat-form-field
              class="pw-input-box"
              floatLabel="never"
              [formGroup]="searchForm"
            >
              <input
                #conversionHistorySearch
                matInput
                class="pw-input-box"
                placeholder="{{
                  requestType === InStockConversionTypesEnumRef.REQUEST_SENT
                    ? ('pw.conversion.searchWithRequestDocNumber' | translate)
                    : ('pw.conversion.searchWithDocNo' | translate)
                }}"
                formControlName="historySearchControl"
                (keypress)="numberCheck($event)"
              />
              <mat-icon matSuffix>
                <span
                  *ngIf="!searchForm.get('historySearchControl').value"
                  class="pw-i-16 pw-search-icon-16"
                ></span
              ></mat-icon>
              <mat-icon matSuffix (click)="clearHistorySearch()">
                <span
                  *ngIf="searchForm.get('historySearchControl').value"
                  class="pw-i-10 pw-close-icon-16"
                ></span
              ></mat-icon>
            </mat-form-field>
          </div>
        </div>
        <div
          *ngIf="
            (hasItem$ | async) && tab === InStockConversionTypesEnumRef.SEARCH
          "
          class="mt-3"
        >
          <div>
            <span class="pw-font-weight-bold">{{
              'pw.conversion.yourProductIsHereText' | translate
            }}</span>
          </div>

          <p class="pt-2">
            {{ 'pw.conversion.parentVariantText' | translate }}
          </p>
          <poss-web-conversion-item
            [item]="parentItem"
            [tab]="0"
            [priceDetails]="mapItemPriceDetails(parentItem?.itemCode)"
            (showPriceDetails)="openPriceDetailsPopup($event)"
            [showButton]="true"
            (isSplitAvailable)="isSplitAvailable($event)"
            [hasForm]="0"
            class="pw-list-card d-block"
            (loadImageEvent)="loadImageUrl($event)"
          >
          </poss-web-conversion-item>

          <ng-container *ngIf="showChildItems == true">
            <div class="pt-4">
              <span class="pw-font-weight-bold">{{
                'pw.conversion.availableSplitOptionsText' | translate
              }}</span>
            </div>
            <div possWebFocusableList>
              <ng-container *ngIf="childItemArray.length > 0">
                <poss-web-conversion-item
                  possWebFocusableListItem
                  *ngFor="let item of childItemArray; trackBy: trackBy"
                  [item]="item"
                  [tab]="0"
                  [parentForm]="parentForm"
                  [hasForm]="1"
                  [binCodes]="binCodes"
                  [conversionWeightToleranceForBangle]="
                    conversionWeightToleranceForBangle
                  "
                  [isWeightEditable]="item.studded ? false : true"
                  class="pw-list-card d-block"
                  (loadImageEvent)="loadImageUrl($event, false, true)"
                  (showPriceDetails)="openPriceDetailsPopup($event)"
                >
                </poss-web-conversion-item>
              </ng-container>
              <ng-container *ngIf="childItemArray.length === 0">
                <poss-web-conversion-item
                  possWebFocusableListItem
                  *ngFor="let item of selectedItem.childItems; trackBy: trackBy"
                  [priceDetails]="mapItemPriceDetails(item?.itemCode)"
                  [item]="item"
                  [tab]="0"
                  [parentForm]="parentForm"
                  [hasForm]="1"
                  [binCodes]="binCodes"
                  [conversionWeightToleranceForBangle]="
                    conversionWeightToleranceForBangle
                  "
                  [isWeightEditable]="item.studded ? false : true"
                  class="pw-list-card d-block"
                  (loadImageEvent)="loadImageUrl($event, false, true)"
                  (showPriceDetails)="openPriceDetailsPopup($event)"
                >
                </poss-web-conversion-item>
              </ng-container>
            </div>
            <div *ngIf="enableAddRowBtn">
              <button class="pw-btn pw-primary-btn" (click)="AddNewChildItem()">
                {{ 'pw.conversion.addRow' | translate }}
              </button>
            </div>
            <div *ngIf="weightMissmatchError" class="pw-error-color">
              {{ weightMissmatchError }}
            </div>
            <div *ngIf="priceMissmatchError" class="pw-error-color">
              {{ priceMissmatchError }}
            </div>

            <div class="row">
              <poss-web-select-dropdown
                class="col-4"
                [control]="rsoForm.get('rsoName')"
                [placeholder]="'pw.conversion.selectRsoText' | translate"
                [options]="rsoNamesArray"
                [required]="true"
              >
              </poss-web-select-dropdown>
            </div>
          </ng-container>
        </div>
      </div>
      <div class="col-12 col-lg-1"></div>
    </div>
  </div>
  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-10 col-12 m-auto">
        <div class="row"></div>
        <div class="pw-scrollable">
          <div *ngIf="tab === InStockConversionTypesEnumRef.REQUEST">
            <poss-web-card-list
              [count]="!searchFormControl.value ? conversionRequestsCount : 0"
              [dataList]="
                !searchFormControl.value
                  ? (conversionRequests$ | async)
                  : (searchedRequestResult$ | async)
              "
              [pageSize]="pageSize"
              (loadMore)="loadRequests($event)"
              (selected)="onSelected($event)"
            >
              <ng-template let-item="data">
                <poss-web-card-title
                  >{{ 'pw.conversion.requestNo' | translate }}:
                  {{ item.srcDocNo }}</poss-web-card-title
                >
                <poss-web-card-subtitle> </poss-web-card-subtitle>
                <poss-web-card-content>
                  <p>
                    {{ item.totalQuantity }}
                    {{ 'pw.conversion.products' | translate }} |
                    {{ item.totalValue | currencyFormatter: item.currencyCode }}
                  </p>
                  <div class="mt-1"></div>
                  <p [ngClass]="getStatus(item.status)">
                    {{ 'pw.conversion.status' | translate }}: {{ status }}
                  </p>
                  <p>
                    {{ item.createdDate | dateFormatter }}
                  </p>
                  <div class="row">
                    <div class="col"></div>
                  </div>
                </poss-web-card-content>
              </ng-template>
            </poss-web-card-list>
          </div>
          <div *ngIf="tab === InStockConversionTypesEnumRef.HISTORY">
            <poss-web-card-list
              [count]="conversionHistoryCount$ | async"
              [dataList]="conversionHistory$ | async"
              [pageSize]="pageSize"
              (loadMore)="loadRequests($event)"
              (selected)="onSelected($event)"
            >
              <ng-template let-item="data">
                <poss-web-card-title
                  >{{
                    requestType === InStockConversionTypesEnumRef.REQUEST_SENT
                      ? ('pw.conversion.requestDocNo' | translate)
                      : ('pw.conversion.docNo' | translate)
                  }}:
                  {{
                    requestType === InStockConversionTypesEnumRef.REQUEST_SENT
                      ? item.reqDocNo
                      : item.srcDocNo
                  }}</poss-web-card-title
                >
                <poss-web-card-subtitle> </poss-web-card-subtitle>
                <poss-web-card-content>
                  <p>
                    {{ item.totalMeasuredQuantity }}
                    {{ 'pw.conversion.products' | translate }} |
                    {{
                      item.totalMeasuredValue
                        | currencyFormatter: item.currencyCode
                    }}
                  </p>
                  <div class="mt-1"></div>
                  <p [ngClass]="getStatus(item.status)">
                    {{ 'pw.conversion.status' | translate }}: {{ status }}
                  </p>
                  <p>
                    {{
                      requestType === InStockConversionTypesEnumRef.REQUEST_SENT
                        ? (item.reqDocDate | dateFormatter)
                        : (item.srcDocDate | dateFormatter)
                    }}
                  </p>
                  <div class="row">
                    <div class="col"></div>
                  </div>
                </poss-web-card-content>
              </ng-template>
            </poss-web-card-list>
          </div>
          <h3
            class="pw-text-center m-5"
            *ngIf="
              tab != InStockConversionTypesEnumRef.SEARCH &&
              tab != InStockConversionTypesEnumRef.HISTORY &&
              (isLoadingConversionRequests$ | async) === false &&
              ((!searchFormControl.value &&
                (conversionRequests$ | async).length === 0) ||
                (searchFormControl.value &&
                  (hasSearchedRequests$ | async) &&
                  (searchedRequestResult$ | async).length === 0))
            "
          >
            {{ noDataFoundMessage }}
          </h3>
          <h3
            class="pw-text-center m-5"
            *ngIf="
              tab === InStockConversionTypesEnumRef.HISTORY &&
              isLoadingConversionHistory == false &&
              (conversionHistory$ | async) &&
              (conversionHistory$ | async).length === 0 &&
              (advanceFilter?.requestToDate === null ||
                advanceFilter?.requestToDate == '') &&
              (advanceFilter?.requestFromDate === null ||
                advanceFilter?.requestFromDate == '') &&
              (advanceFilter?.fiscalYear === null ||
                advanceFilter?.fiscalYear == '') &&
              (advanceFilter?.statuses == null || advanceFilter?.statuses == '')
            "
          >
            {{ 'pw.conversion.noTransactionExists' | translate }}
          </h3>
          <h3
            class="pw-text-center m-5"
            *ngIf="
              tab === InStockConversionTypesEnumRef.HISTORY &&
              isLoadingConversionHistory == false &&
              (conversionHistory$ | async) &&
              (conversionHistory$ | async).length === 0 &&
              !(
                (advanceFilter?.requestToDate === null ||
                  advanceFilter?.requestToDate == '') &&
                (advanceFilter?.requestFromDate === null ||
                  advanceFilter?.requestFromDate == '') &&
                (advanceFilter?.fiscalYear === null ||
                  advanceFilter?.fiscalYear == '') &&
                (advanceFilter?.statuses == null ||
                  advanceFilter?.statuses == '')
              )
            "
          >
            {{
              'pw.conversion.noTransactionExistsWithTheSelectedCombination'
                | translate
            }}
          </h3>
          <poss-web-loader
            *ngIf="
              (isLoadingConversionRequests$ | async) ||
              (isLoadingCount$ | async) ||
              (isLoadingConversionItems$ | async) ||
              (isSearchingRequests$ | async) ||
              (isLoadingRsoDetails$ | async) ||
              (isLoadingHistory$ | async) ||
              (isSearchingItems$ | async) ||
              (isLoadingImage$ | async)
            "
          >
          </poss-web-loader>
        </div>
      </div>
    </div>
  </div>
</div>
<ng-template #confirmSuccessNotificationTemplate>
  <div class="pw-text-center">
    <h3 class="pw-success-color">
      {{
        'pw.conversionNotificationMessages.convertNowSuccessOverlayMessage1'
          | translate
      }}
    </h3>
    <div class="pt-2">
      {{
        'pw.conversionNotificationMessages.convertNowSuccessOverlayMessage2'
          | translate
      }}
    </div>
    <h5 class="pw-success-color pt-2">
      {{
        'pw.conversionNotificationMessages.convertNowSuccessOverlayMessage3'
          | translate
      }}{{ conversionDocNo }}
    </h5>
  </div>
</ng-template>

<ng-template #confirmRequestSuccessNotificationTemplate>
  <div class="pw-text-center">
    <h3 class="pw-success-color">
      {{
        'pw.conversionNotificationMessages.sendRequestSuccessOverlayMessage1'
          | translate
      }}
    </h3>
    <div class="pt-2">
      {{
        'pw.conversionNotificationMessages.sendRequestSuccessOverlayMessage2'
          | translate
      }}
    </div>
    <h5 class="pw-success-color pt-2">
      {{
        'pw.conversionNotificationMessages.sendRequestSuccessOverlayMessage3'
          | translate
      }}{{ sendReqDocNo }}
    </h5>
  </div>
</ng-template>
