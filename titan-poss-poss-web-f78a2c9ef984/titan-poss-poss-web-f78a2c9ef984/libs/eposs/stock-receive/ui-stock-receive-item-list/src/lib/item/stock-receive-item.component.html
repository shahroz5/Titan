<div [formGroup]="itemForm" class="row no-gutters">
  <poss-web-item-details
    [item]="itemData"
    [toLoadImageUrlFromAPI]="true"
    [showHallmarkDetails]="isL3Store ? true : false"
    (loadImageEvent)="loadImage()"
  >
  </poss-web-item-details>
  <div class="col-auto pw-list-card__item">
    <div class="row no-gutters pw-input-group">
      <div class="col-auto pw-input-group__item">
        <div class="pw-input-group__item-label">
          {{ 'pw.stockReceive.quantityLableText' | translate }}
        </div>
        <input
          type="number"
          class="pw-bg-input-box pw-input-group__item-border-right"
          placeholder="{{
            'pw.stockReceive.measuredQuantityPlaceholderText' | translate
          }}"
          formControlName="measuredQuantity"
        />
      </div>
      <div class="col-auto pw-input-group__item">
        <div class="pw-input-group__item-label">
          {{ 'pw.stockReceive.itemWeightLableText' | translate }} :
        </div>
        <div class="pw-input-group__item-label" *ngIf="!isL3Store">
          {{ item.availableWeight | weightFormatter }} {{ item.weightUnit }}
        </div>
        <input
          possWebWeightInput
          class="pw-bg-input-box pw-input-group__item-border-right"
          [ngClass]="{
            'pw-error-bg':
              (itemForm.get('measuredWeight').dirty &&
                itemForm.get('measuredWeight').invalid) ||
              isWeightMismatch,
            'pw-success-bg': itemForm.get('measuredWeight').valid
          }"
          placeholder="{{
            'pw.stockReceive.measuredWeightPlaceholderText' | translate
          }}
          "
          formControlName="measuredWeight"
          (blur)="measuredWeightChange()"
        />
      </div>
      <div class="col-auto pw-input-group__item" *ngIf="isL3Store">
        <div class="pw-input-group__item-label">
          {{ 'pw.stockReceive.discountLabel' | translate }} ({{
            defaultCurrencyCode | currencySymbol
          }}) :
        </div>
        <!-- <div class="pw-input-group__item-label" *ngIf="!isL3Store">
          {{ item.itemLevelDiscount}}
        </div> -->
        <input
          class="pw-bg-input-box pw-input-group__item-border-right"
          formControlName="itemLevelDiscount"
        />
      </div>

      <div class="col-auto pw-input-group__item" *ngIf="isL3Store">
        <div class="pw-input-group__item-label pw-input-box">
          {{ 'pw.stockReceive.finalValueLabel' | translate }} ({{
            defaultCurrencyCode | currencySymbol
          }}) :
          <span
            class="pw-i-14 pw-info-icon-14"
            [matMenuTriggerFor]="priceDetailsInfoMenu"
          ></span>
        </div>
        <input
          class="pw-bg-input-box pw-input-group__item-border-right"
          formControlName="finalValue"
        />

        <mat-menu
          #priceDetailsInfoMenu="matMenu"
          class="pw-overlay-notification-band__menu"
        >
          <div class="d-flex pw-menu-item__margin">
            <div class="d-flex flex-column pw-tertiary-color">
              <div
                *ngIf="
                  itemForm.get('pricePerUnit').value &&
                  itemForm.get('pricePerUnit').value !== 0
                "
                class="pw-overlay-notification-band__menu-item"
              >
                {{ 'pw.stockReceive.pricePerUnitLabel' | translate }}
              </div>
              <div
                *ngIf="
                  itemForm.get('preTaxValue').value &&
                  itemForm.get('preTaxValue').value !== 0
                "
                class="pw-overlay-notification-band__menu-item"
              >
                {{ 'pw.stockReceive.preTaxValueLabel' | translate }}
              </div>
              <div
                *ngIf="
                  itemForm.get('totalTax').value &&
                  itemForm.get('totalTax').value !== 0
                "
                class="pw-overlay-notification-band__menu-item"
              >
                {{ 'pw.stockReceive.totalTaxLabel' | translate }}
              </div>
            </div>
            <div class="d-flex flex-column mx-2 pw-tertiary-color">
              <div
                *ngIf="
                  itemForm.get('pricePerUnit').value &&
                  itemForm.get('pricePerUnit').value !== 0
                "
                class="pw-overlay-notification-band__menu-item"
              >
                :
              </div>
              <div
                *ngIf="
                  itemForm.get('preTaxValue').value &&
                  itemForm.get('preTaxValue').value !== 0
                "
                class="pw-overlay-notification-band__menu-item"
              >
                :
              </div>
              <div
                *ngIf="
                  itemForm.get('totalTax').value &&
                  itemForm.get('totalTax').value !== 0
                "
                class="pw-overlay-notification-band__menu-item"
              >
                :
              </div>
            </div>
            <div class="d-flex flex-column pw-font-weight-bold pw-text-right">
              <div
                *ngIf="
                  itemForm.get('pricePerUnit').value &&
                  itemForm.get('pricePerUnit').value !== 0
                "
                class="pw-overlay-notification-band__menu-item"
              >
                {{ itemForm.get('pricePerUnit').value | currencyFormatter }}
              </div>
              <div
                *ngIf="
                  itemForm.get('preTaxValue').value &&
                  itemForm.get('preTaxValue').value !== 0
                "
                class="pw-overlay-notification-band__menu-item"
              >
                {{ itemForm.get('preTaxValue').value | currencyFormatter }}
              </div>
              <div
                *ngIf="
                  itemForm.get('totalTax').value &&
                  itemForm.get('totalTax').value !== 0
                "
                class="pw-overlay-notification-band__menu-item"
              >
                {{ itemForm.get('totalTax').value | currencyFormatter }}
              </div>
            </div>
          </div>
        </mat-menu>
      </div>

      <div class="col-auto pw-input-group__item">
        <div class="pw-input-group__item-label">
          {{ 'pw.stockReceive.assginedBinGroupLableText' | translate }}
        </div>

        <mat-select
          disableOptionCentering
          [ngClass]="{
            'pw-error-bg': itemForm.get('binGroupCode').value != binGroupCode,
            'pw-success-bg': itemForm.get('binGroupCode').value == binGroupCode
          }"
          class="pw-bg-input-box pw-select-bingroup pw-select-box-padding pw-input-group__item-border-left"
          formControlName="binGroupCode"
          placeholder="{{
            'pw.stockReceive.selectPlaceholderText' | translate
          }}"
        >
          <ng-container *ngFor="let bin of binGroupCodes">
            <mat-option
              [value]="bin"
              *ngIf="
                !(
                  (itemForm.get('measuredWeight').value == null &&
                    bin == stockItemBinGroupCodeEnumRef.DISPUTE) ||
                  (!isWeightMismatch &&
                    bin == stockItemBinGroupCodeEnumRef.DISPUTE) ||
                  (itemForm.get('measuredWeight').value != null &&
                    isWeightMismatch &&
                    bin != stockItemBinGroupCodeEnumRef.DISPUTE)
                )
              "
            >
              {{ bin }}
            </mat-option>
          </ng-container>
        </mat-select>
      </div>
    </div>
  </div>
  <div
    class="col-2 pw-list-card__item"
    *ngIf="
      itemForm.get('binGroupCode').value ===
      stockItemBinGroupCodeEnumRef.DEFECTIVE
    "
  >
    <div class="pw-sub-heading">
      {{ 'pw.stockReceive.remarksLableText' | translate }}
    </div>
    <mat-select
      disableOptionCentering
      class="pw-select-box-padding pw-bg-input-box pw-error-bg pw-w-100"
      formControlName="remarkGroupCode"
      placeholder="{{ 'pw.stockReceive.selectPlaceholderText' | translate }}"
      (selectionChange)="updateItem()"
    >
      <mat-option *ngFor="let remark of remarks" [value]="remark.code">
        {{ remark.value }}</mat-option
      >
    </mat-select>
  </div>

  <div
    class="col-2 pw-list-card__item"
    *ngIf="
      isVerified &&
      (itemForm.get('binGroupCode').value ===
        stockItemBinGroupCodeEnumRef.STN ||
        itemForm.get('binGroupCode').value ===
          stockItemBinGroupCodeEnumRef.PURCFA)
    "
  >
    <div class="pw-sub-heading">
      {{ 'pw.stockReceive.assginedBinCodeLableText' | translate }}
    </div>
    <button
      mat-flat-button
      class="pw-btn pw-accent-btn"
      (click)="openBinSelectionPopup()"
    >
      <div class="row no-gutters pw-text-left">
        <div class="col pw-text-overflow-ellipisis">
          <p class="pw-text-overflow-ellipisis">
            <ng-container *ngIf="selectedBinCode; else showSelectBin">
              {{ selectedBinCode }}
            </ng-container>
            <ng-template #showSelectBin>
              {{ 'pw.stockReceive.selectBinCodeLable' | translate }}
            </ng-template>
          </p>
        </div>
        <div class="col-auto ml-auto">
          <span class="pw-i-16 pw-bin-icon-16"></span>
        </div>
      </div>
    </button>
  </div>

  <div
    class="col-auto pw-list-card__right-container"
    *ngIf="
      !isVerified ||
      (isVerified &&
        showUpdateStatus &&
        (item.isUpdating ||
          item.isValidating ||
          item.isUpdatingSuccess == false))
    "
  >
    <ng-container *ngIf="!isVerified">
      <button
        *ngIf="!(item.isUpdating || item.isValidating)"
        mat-button
        class="pw-btn pw-primary-btn pw-verify-button"
        [disabled]="itemForm.invalid"
        (click)="verifyItem()"
      >
        {{ 'pw.stockReceive.verifyButtonText' | translate }}
      </button>
      <button
        *ngIf="item.isUpdating || item.isValidating"
        mat-button
        class="pw-primary-btn"
      >
        ...
      </button>
    </ng-container>

    <ng-container *ngIf="isVerified && showUpdateStatus">
      <span class="pw-success-color pw-sub-heading" *ngIf="item.isUpdating">
        {{ 'pw.stockReceive.savingInfoMessge' | translate }} ...
      </span>

      <span class="pw-success-color pw-sub-heading" *ngIf="item.isValidating">
        {{ 'pw.otherReceiptsIssues.validatingInfoMessge' | translate }} ...
      </span>

      <span
        class="pw-error-color pw-sub-heading"
        *ngIf="item.isUpdatingSuccess == false"
      >
        <span class="pw-i-16 pw-warning-icon-16"></span>
        {{ 'pw.stockReceive.updateFailedMessage' | translate }}
      </span>
    </ng-container>
  </div>
</div>
<div class="row">
  <div class="flex-fill"></div>
  <div
    class="col-auto pw-list-card__error-label"
    *ngIf="
      isWeightMismatch && !itemForm.get('measuredWeight').hasError('minZero')
    "
  >
    <span class="pw-i-16 pw-warning-icon-16"></span>
    {{ 'pw.stockReceive.weightMismatchErrorMessage' | translate }}
  </div>
  <mat-error
    *ngIf="
      itemForm.get('measuredQuantity').errors &&
      itemForm.get('measuredQuantity').errors.errorArray
    "
  >
    <poss-web-error-info-tooltip
      [errorMessage]="itemForm.get('measuredQuantity').errors.errorArray"
    ></poss-web-error-info-tooltip>
  </mat-error>

  <div
    class="col-auto pw-list-card__error-label"
    *ngIf="
      itemForm.get('measuredWeight').dirty &&
      itemForm.get('measuredWeight').hasError('required')
    "
  >
    <span class="pw-i-16 pw-warning-icon-16"></span>
    {{ 'pw.stockReceive.weightRequiredErrorMessage' | translate }}
  </div>

  <div
    class="col-auto pw-list-card__error-label"
    *ngIf="
      itemForm.get('measuredWeight').dirty &&
      !itemForm.get('measuredWeight').hasError('required') &&
      itemForm.get('measuredWeight').hasError('minZero')
    "
  >
    <span class="pw-i-16 pw-warning-icon-16"></span>
    {{ itemForm.get('measuredWeight').getError('minZero') | translate }}
  </div>

  <div
    class="col-auto pw-list-card__error-label"
    *ngIf="itemForm.hasError('remarkGroupCode')"
  >
    <span class="pw-i-16 pw-warning-icon-16"></span>
    {{ itemForm.getError('remarkGroupCode') | translate }}
  </div>

  <div
    class="col-auto pw-list-card__error-label"
    *ngIf="!isVerified && item.isUpdatingSuccess == false"
  >
    <span class="pw-i-16 pw-warning-icon-16"></span>
    {{ 'pw.stockReceive.verifyFailedMessage' | translate }}
  </div>
</div>
