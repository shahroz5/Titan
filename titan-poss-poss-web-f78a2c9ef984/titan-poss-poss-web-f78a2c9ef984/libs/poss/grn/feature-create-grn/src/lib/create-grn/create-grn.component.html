<div class="pw-detail-card pw-shadow">
  <div class="pw-detail-card__heading">
    {{ 'pw.grn.cmDetails' | translate }}
  </div>
  <div class="row pw-detail-card__flex-end" [formGroup]="grnFormGroup">
    <button
      *ngIf="!locationCode"
      mat-flat-button
      class="ml-3 mb-3 pw-btn pw-cta-btn"
      (click)="openLocationSelectionPopup()"
      [disabled]="initiate"
    >
      <div class="row">
        <div class="col-auto">
          <p>{{ boutiqueCode }} - {{ boutiqueDesc }}</p>
        </div>
        <div class="col-auto ml-auto">
          <span class="pw-i-16 pw-location-icon-16"></span>
        </div>
      </div>
    </button>

    <button
      *ngIf="locationCode"
      mat-flat-button
      class="ml-3 mb-3 pw-btn pw-cta-btn"
      [disabled]="initiate"
    >
      <div class="row">
        <div class="col-auto">
          <p>
            {{ selectedLocation.description }}
          </p>
        </div>

        <div *ngIf="!initiate" class="col-auto ml-auto">
          <a>
            <span
              class="pw-i-10 pw-close-icon-16"
              (click)="clearLocation()"
            ></span>
          </a>
        </div>
      </div>
    </button>
    <mat-form-field class="col-auto">
      <input
        matInput
        formControlName="refDocNo"
        class="pw-single-bordered-input"
        placeholder="Enter CM Number"
      />
      <mat-error
        *ngIf="
          grnFormGroup.get('refDocNo').errors &&
          grnFormGroup.get('refDocNo').errors.errorArray
        "
      >
        <poss-web-error-info-tooltip
          [errorMessage]="grnFormGroup.get('refDocNo').errors.errorArray"
        ></poss-web-error-info-tooltip>
      </mat-error>
    </mat-form-field>
    <poss-web-fiscal-year
      class="col-lg-2 col-3"
      [control]="grnFormGroup.get('fiscalYear')"
      [required]="grnFormGroup.get('refDocNo').value !== '' ? true : false"
      [currentFiscalYear]="currentFiscalYear"
      [placeHolder]="'pw.creditNote.searchByFiscalYearLabel' | translate"
      [disabled]="false"
    ></poss-web-fiscal-year>

    <div class="col-auto ml-auto align-self-baseline">
      <button
        class="pw-btn pw-accent-btn"
        (click)="initiateGrn()"
        [disabled]="!grnFormGroup.valid || initiate"
      >
        Initiate GRN
      </button>
    </div>
  </div>
  <div *ngIf="grnDetails" class="row pw-detail-card__secondary-section">
    <div class="col-lg-2 col-2">
      <div class="pw-detail-card__label">
        {{ 'pw.grn.cmDate' | translate }}
      </div>
      <div class="pw-font-weight-bold">
        {{ grnDetails?.refDocDate | dateFormatter }}
      </div>
    </div>
    <div class="col-lg-2 col-2" *ngIf="grnDetails.invoicedGoldRate">
      <div class="pw-detail-card__label">
        {{ 'pw.grn.invoicedGoldRate' | translate }}
      </div>
      <div class="pw-font-weight-bold">
        {{ grnDetails?.invoicedGoldRate | currencyFormatter: currencyCode }}/
        {{ 'pw.grn.gmLabel' | translate }}
      </div>
    </div>
    <div class="col-lg-2 col-2" *ngIf="grnDetails.invoicedPlatinumRate">
      <div class="pw-detail-card__label">
        {{ 'pw.grn.invoicedPlatinumRate' | translate }}
      </div>
      <div class="pw-font-weight-bold">
        {{
          grnDetails?.invoicedPlatinumRate | currencyFormatter: currencyCode
        }}/
        {{ 'pw.grn.gmLabel' | translate }}
      </div>
    </div>
    <div class="col-lg-2 col-2" *ngIf="grnDetails.invoicedSilverRate">
      <div class="pw-detail-card__label">
        {{ 'pw.grn.invoicedSilverRate' | translate }}
      </div>
      <div class="pw-font-weight-bold">
        {{ grnDetails?.invoicedSilverRate | currencyFormatter: currencyCode }}/
        {{ 'pw.grn.gmLabel' | translate }}
      </div>
    </div>
  </div>
</div>

<mat-expansion-panel
  *ngIf="details"
  [expanded]="details"
  class="pw-expansion-panel"
>
  <mat-expansion-panel-header
    class="pw-expansion-panel__header"
    [collapsedHeight]="'40px'"
    [expandedHeight]="'40px'"
  >
    <mat-panel-title class="pw-expansion-panel__heading">
      {{ 'pw.cmRequestApproval.productDetailsLabel' | translate }}
    </mat-panel-title>
  </mat-expansion-panel-header>
  <div class="pw-card pw-panel">
    <div class="align-items-center">
      <div [formGroup]="radioFormGroup" *ngIf="productDetails?.length !== 0">
        <mat-radio-group class="row" formControlName="selectRadioButton">
          <mat-radio-button
            [value]="grnEnumRef.REGULAR_GRN"
            class="col-auto ml-auto"
          >
            <p class="pw-radio-btn__label">Regular GRN</p></mat-radio-button
          >
          <mat-radio-button [value]="grnEnumRef.MFG_DEFECT" class="col-auto">
            <p class="pw-radio-btn__label">Manufacturing Defect</p>
          </mat-radio-button>
        </mat-radio-group>
      </div>
      <poss-web-create-grn-details
        *ngIf="grnDetails"
        [productDetails]="productDetails"
        [isLegacy]="isLegacy"
        [item$]="item$.asObservable()"
        [imageUrlData$]="imageUrlData$.asObservable()"
        [pgDesc$]="pgDesc$"
        [rsoNames]="rsoDetails$ | async"
        [grnDetails]="grnDetails"
        (loadImageUrl)="loadImageUrl($event)"
        (items)="getItems($event)"
        (quantity)="quantityChange($event)"
      ></poss-web-create-grn-details>
    </div>
  </div>
</mat-expansion-panel>
<div *ngIf="grnDetails" class="pw-detail-card pw-shadow">
  <div class="pw-detail-card__heading">
    {{ 'pw.grn.grnAndApprovalDetails' | translate }}
  </div>
  <div class="row">
    <div class="col-lg-auto col-auto">
      <div class="pw-detail-card__label">
        {{ 'pw.grn.cmNetAmount' | translate }}
      </div>
      <div class="pw-font-weight-bold">
        {{ grnDetails?.cmNetAmount | currencyFormatter: currencyCode }}
      </div>
    </div>
    <div class="col-lg-auto col-auto">
      <div class="pw-detail-card__label">
        {{ 'pw.grn.otherCharges' | translate }}
      </div>
      <div class="pw-font-weight-bold">
        {{ grnDetails?.otherCharges | currencyFormatter: currencyCode }}
      </div>
    </div>
    <!-- <div class="col-lg-auto col-auto" *ngIf="grnDetails?.txnSource === 'LEGACY'; else napCashmemo">
      <div class="pw-detail-card__label">
        {{ 'pw.grn.encirclePoints' | translate }}
      </div>
      <div class="pw-font-weight-bold">{{ grnDetails?.encirclePoints }}</div>
    </div>
    <ng-template #napCashmemo>
      <div class="col-lg-auto col-auto">
        <div class="pw-detail-card__label">
          {{ 'pw.grn.encirclePoints' | translate }}
        </div>
        <div class="pw-font-weight-bold">{{ grnDetails?.loyaltyPoints }}</div>
      </div>
    </ng-template> -->
    <div class="col-lg-auto col-auto">
      <div class="pw-detail-card__label">
        {{ 'pw.grn.encirclePoints' | translate }}
      </div>
      <div class="pw-font-weight-bold">{{ encirclePoints }}</div>
    </div>
    <div class="col-lg-auto col-auto">
      <div class="pw-detail-card__label">TCS to be Refund</div>
      <div class="pw-font-weight-bold">
        {{ tcsCollectedAmount | currencyFormatter: currencyCode }}
      </div>
    </div>
    <div class="col-lg-auto col-auto">
      <div class="pw-detail-card__label">FOC Recovered Value</div>
      <div class="pw-font-weight-bold">
        {{
          (focDeductionValue ? focDeductionValue : 0)
            | currencyFormatter: currencyCode
        }}
      </div>
    </div>
    <div class="col-lg-auto col-auto">
      <div class="pw-detail-card__label">Bin</div>
      <div
        class="pw-font-weight-bold"
        *ngIf="grnType === grnEnumRef.REGULAR_GRN"
      >
        GRN
      </div>
      <div
        class="pw-font-weight-bold"
        *ngIf="grnType === grnEnumRef.MFG_DEFECT"
      >
        DEFECTIVE
      </div>
    </div>
  </div>
  <div *ngIf="productDetails?.length !== 0">
    <div
      class="pw-detail-card__secondary-section"
      *ngIf="grnType === grnEnumRef.REGULAR_GRN && confirm"
    >
      <!-- <div class="pw-font-weight-bold">Other Details</div> -->
      <div
        class="pw-font-weight-bold"
        *ngIf="grnType === grnEnumRef.REGULAR_GRN"
      >
        {{ 'pw.grn.regularLabel' | translate }}
      </div>
      <div class="row pw-detail-card__list align-items-end">
        <poss-web-select-dropdown
          class="col-lg-2 col-3"
          [placeholder]="'pw.grn.selectReasonLabel' | translate"
          [required]="true"
          [options]="reasonDropDown"
          [control]="reasonControl"
        >
        </poss-web-select-dropdown>
        <mat-form-field
          class="col-lg-4 col-8"
          *ngIf="reasonControl.value === 'OTHERS'"
        >
          <textarea
            matInput
            class="pw-single-bordered-input"
            placeholder="Other Reasons"
            [formControl]="otherReasonControl"
          ></textarea>
          <mat-error
            *ngIf="
              otherReasonControl &&
              otherReasonControl.errors &&
              otherReasonControl.errors.errorArray
            "
          >
            <poss-web-error-info-tooltip
              [errorMessage]="otherReasonControl.errors.errorArray"
            ></poss-web-error-info-tooltip>
          </mat-error>
        </mat-form-field>
      </div>
    </div>
    <div
      class="pw-detail-card__secondary-section"
      *ngIf="
        (grnType === grnEnumRef.REGULAR_GRN && !confirm) ||
        grnType === grnEnumRef.MFG_DEFECT
      "
    >
      <div
        class="pw-font-weight-bold"
        *ngIf="grnType === grnEnumRef.MFG_DEFECT"
      >
        {{ 'pw.grn.manfDefectLabel' | translate }}
      </div>
      <div
        class="pw-font-weight-bold"
        *ngIf="grnType === grnEnumRef.REGULAR_GRN"
      >
        {{ 'pw.grn.regularLabel' | translate }}
      </div>
      <div [formGroup]="approvalFormGroup">
        <div class="row pw-detail-card__list">
          <poss-web-select-dropdown
            class="col-lg-2 col-3"
            [placeholder]="'pw.grn.selectApproverLabel' | translate"
            [required]="true"
            [options]="approvers"
            [control]="approvalFormGroup.get('approverRoleCode')"
          >
          </poss-web-select-dropdown>

          <mat-form-field
            *ngIf="approvalType === 'CODE'"
            class="col-lg-2 col-3"
          >
            <input
              matInput
              formControlName="approvalCode"
              class="pw-single-bordered-input"
              placeholder="Approval code"
            />
            <mat-error
              *ngIf="
                approvalFormGroup.get('approvalCode').errors &&
                approvalFormGroup.get('approvalCode').errors.errorArray
              "
            >
              <poss-web-error-info-tooltip
                [errorMessage]="
                  approvalFormGroup.get('approvalCode').errors.errorArray
                "
              ></poss-web-error-info-tooltip>
            </mat-error>
          </mat-form-field>
          <mat-form-field
            *ngIf="approvalType === 'CODE'"
            class="col-lg-2 col-3"
          >
            <input
              matInput
              formControlName="ccafNo"
              class="pw-single-bordered-input"
              placeholder="CCAF No"
            />
            <mat-error
              *ngIf="
                approvalFormGroup.get('ccafNo').errors &&
                approvalFormGroup.get('ccafNo').errors.errorArray
              "
            >
              <poss-web-error-info-tooltip
                [errorMessage]="
                  approvalFormGroup.get('ccafNo').errors.errorArray
                "
              ></poss-web-error-info-tooltip>
            </mat-error>
          </mat-form-field>
          <mat-form-field
            class="col-lg-2 col-3"
            *ngIf="approvalType === 'EMAIL'"
          >
            <mat-label>Approval Date</mat-label>
            <input
              matInput
              [matDatepicker]="picker"
              formControlName="approvalDate"
              [max]="businessDate"
              [min]="grnDetails?.refDocDate"
            />
            <mat-datepicker-toggle
              matSuffix
              [for]="picker"
            ></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            <mat-error
              *ngIf="
                approvalFormGroup.get('approvalDate').errors &&
                approvalFormGroup.get('approvalDate').errors.errorArray
              "
            >
              <poss-web-error-info-tooltip
                [errorMessage]="
                  approvalFormGroup.get('approvalDate').errors.errorArray
                "
              ></poss-web-error-info-tooltip>
            </mat-error>
          </mat-form-field>
          <div *ngIf="approvalType === 'EMAIL'" class="col-lg-2 col-3 mt-3">
            <!-- <poss-web-file-upload
              [uploadLabel]="'upload Approval Mail'"
              (fileEmitter)="upload($event)"
              (errorEmitter)="uploadError($event)"
            ></poss-web-file-upload> -->
          </div>
        </div>
        <div class="row pw-detail-card__list align-items-end">
          <poss-web-select-dropdown
            class="col-lg-2 col-3"
            [placeholder]="'pw.grn.selectReasonLabel' | translate"
            [required]="true"
            [options]="reasonDropDown"
            [control]="approvalFormGroup.get('reasonForCancellation')"
          >
          </poss-web-select-dropdown>

          <mat-form-field
            *ngIf="
              approvalFormGroup.get('reasonForCancellation').value === 'OTHERS'
            "
            class="col-lg-4 col-8"
          >
            <textarea
              matInput
              class="pw-single-bordered-input"
              placeholder="Other Reasons"
              [formControl]="approvalFormGroup.get('otherReasons')"
            ></textarea>
            <mat-error
              *ngIf="
                approvalFormGroup.get('otherReasons').errors &&
                approvalFormGroup.get('otherReasons').errors.errorArray
              "
            >
              <poss-web-error-info-tooltip
                [errorMessage]="
                  approvalFormGroup.get('otherReasons').errors.errorArray
                "
              ></poss-web-error-info-tooltip>
            </mat-error>
          </mat-form-field>
        </div>
      </div>
    </div>
  </div>
</div>
<div *ngIf="grnDetails && productDetails?.length !== 0">
  <div
    *ngIf="
      (grnType === grnEnumRef.REGULAR_GRN && !confirm) ||
      grnType === grnEnumRef.MFG_DEFECT
    "
  >
    <poss-web-file-multi-upload
      *ngIf="approvalType === 'EMAIL'"
      [title]="fileUploadTitle"
      [fileType]="fileType"
      [docType]="'GRN'"
    ></poss-web-file-multi-upload>
  </div>
</div>

<div
  *ngIf="(hasError$ | async)?.code === searchErrorCode && !customerId"
  class="pw-message pw-text-center mg-t-100"
>
  {{ 'pw.grn.noSearchResultText' | translate }}
</div>
<ng-template #confirmSuccessNotificationTemplate>
  <div class="pw-text-center">
    <h3 class="pw-success-color">
      {{ 'pw.grn.grnConfirmMesgNew' | translate }}
    </h3>
    <h5>
      <span class="pw-success-color pt-2">
        {{ 'pw.grn.grnNoMsg' | translate }}
      </span>
      <span>{{ docNo }} </span>
    </h5>
    <h5>
      <span class="pw-success-color pt-2">
        {{ 'pw.grn.grnConfirmMesgNew2' | translate }}
      </span>
      <span>{{ cnDocNo }} </span>
      <span class="pw-success-color pt-2"
        >{{ 'pw.grn.amtMsg' | translate }}
      </span>
      <span> {{ cnAmt | currencyFormatter: currencyCode }}</span>
    </h5>
    <h5 *ngIf="tcsCnAmt" class="pt-2">
      <span> {{ 'pw.grn.tcsCnAmt' | translate }}</span
      >:
      {{ tcsCnAmt | currencyFormatter: currencyCode }}
    </h5>

    <h4 class="pw-success-color pw-pointer" (click)="print()">
      <span class="pw-i-16 pw-download-icon-16 pw-print"></span>
      {{ 'pw.advanceBooking.print' | translate }}
    </h4>
  </div>
</ng-template>
<ng-template #confirmSuccessNotificationTemplateApproval>
  <div class="pw-text-center">
    <h3 class="pw-success-color">
      {{ 'pw.grn.grnRequestMsg' | translate }}
    </h3>
    <h5 class="pw-success-color pt-2">
      {{ 'pw.grn.reqNo' | translate }} {{ reqNo }}
    </h5>
  </div>
</ng-template>
<poss-web-loader
  *ngIf="
    (isLoading$ | async) ||
    (isCommonLoading$ | async) ||
    (printingService.getPrinterIsLoading() | async)
  "
></poss-web-loader>
